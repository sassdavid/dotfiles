#!/usr/bin/env bash

# https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install

set -e

test -z "${TMPDIR}" && TMPDIR="$(mktemp -d)"
ZIP_FILE="${TMPDIR}/awscliv2.zip"

download() {
  rm -f "${ZIP_FILE}"

  local DOWNLOAD_PATH="https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"

  printf "Download aws from %s to '%s'\n" "${DOWNLOAD_PATH}" "${TMPDIR}"

  curl -s -L -o "${ZIP_FILE}" \
    "${DOWNLOAD_PATH}"

  printf "Unzip file '%s' to '%s'\n" "${ZIP_FILE}" "${TMPDIR}"
  unzip -q "${ZIP_FILE}" -d "${TMPDIR}"
}

download
if [ -f /usr/local/bin/aws ]; then
  sudo "${TMPDIR}"/aws/install --update
else
  sudo "${TMPDIR}"/aws/install
fi

aws --version

printf "Cleanup...\n"
rm -rf "${TMPDIR}"
