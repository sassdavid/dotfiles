#!/usr/bin/env bash

set -e

RELEASE_URL="https://go.dev/dl"
test -z "${TMPDIR}" && TMPDIR="$(mktemp -d -t go.XXXXXXXXXX)"
BIN_FILE="${TMPDIR}"
INSTALL_DIR="/usr/local"

last_version() {
  curl -s 'https://go.dev/VERSION?m=text' |
    head -n1
}

download() {
  test -z "${VERSION}" && local VERSION && VERSION="$(last_version)"
  test -z "${VERSION}" && {
    echo "Unable to get go version." >&2
    exit 1
  }

  local OS
  OS=$(uname -s | tr '[:upper:]' '[:lower:]')

  local ARC
  ARC=$([ "$(uname -m)" = "x86_64" ] && echo "amd64" || echo "386")

  local FILE_NAME="${VERSION}.${OS}-${ARC}.tar.gz"

  BIN_FILE="${BIN_FILE}/${FILE_NAME}"

  sudo rm -rf "${INSTALL_DIR}/go"
  rm -f "${BIN_FILE}"

  local DOWNLOAD_URL="${RELEASE_URL}/${FILE_NAME}"

  printf "Download go from %s to '%s'\n" "${DOWNLOAD_URL}" "${TMPDIR}"
  curl -s -L -o "${BIN_FILE}" \
    "${DOWNLOAD_URL}"
}

download
sudo tar -xzf "${BIN_FILE}" -C "${INSTALL_DIR}"

"${INSTALL_DIR}/go/bin/go" version

printf "Cleanup...\n"
rm -rf "${TMPDIR}"
