#!/usr/bin/env bash

set -e

RELEASES_URL="https://github.com/derailed/k9s/releases/download"
test -z "${TMPDIR}" && TMPDIR="$(mktemp -d -t k9s.XXXXXXXXXX)"
ZIP_FILE="${TMPDIR}"
BIN_FILE="${TMPDIR}/k9s"

download() {
  local K9S_VERSION="v0.26.7"

  local OS
  OS=$(uname -s)

  local ARC
  ARC=$(uname -m)

  local FILE_NAME="k9s_${OS}_${ARC}.tar.gz"

  ZIP_FILE="${ZIP_FILE}/${FILE_NAME}"

  rm -f "${ZIP_FILE}"

  local DOWNLOAD_URL="${RELEASES_URL}/${K9S_VERSION}/${FILE_NAME}"

  printf "Download k9s from %s to '%s'\n" "${DOWNLOAD_URL}" "${TMPDIR}"
  curl -s -L -o "${ZIP_FILE}" \
    "${DOWNLOAD_URL}"

  tar -xzf "${ZIP_FILE}" -C "${TMPDIR}"
}

download
chmod +x "${BIN_FILE}"
"${BIN_FILE}" version
sudo mv "${BIN_FILE}" /usr/local/bin/k9s

printf "Cleanup...\n"
rm -rf "${TMPDIR}"
