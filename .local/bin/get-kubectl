#!/usr/bin/env bash

set -e

RELEASE_URL="https://dl.k8s.io/release"
test -z "$TMPDIR" && TMPDIR="$(mktemp -d)"
BIN_FILE="$TMPDIR/kubectl"

download() {
  local KUBECTL_VERSION="v1.25.15"

  rm -f "$BIN_FILE"

  local OS
  OS=$(uname -s | tr '[:upper:]' '[:lower:]')

  local ARC
  ARC=$([ "$(uname -m)" = "x86_64" ] && echo "amd64" || echo "386")

  local DOWNLOAD_PATH="$RELEASE_URL/${KUBECTL_VERSION}/bin/$OS/$ARC/kubectl"

  printf "Download kubectl from %s to '%s'\n" "${DOWNLOAD_PATH}" "${TMPDIR}"
  curl -s -L -o "${BIN_FILE}" \
    "${DOWNLOAD_PATH}"
}

download
chmod +x "${BIN_FILE}"
"${BIN_FILE}" version --client --output=yaml

sudo mv "${BIN_FILE}" /usr/local/bin/kubectl

printf "Cleanup...\n"
rm -rf "${TMPDIR}"
