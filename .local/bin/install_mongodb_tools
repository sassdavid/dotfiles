#!/usr/bin/env bash
# bashsupport disable=BP5001,BP5007,BP5008

set -o errexit
set -o pipefail
set -o nounset

default_install_path="$HOME/.local/bin"
install_path="${1:-$default_install_path}"

auth_header=""
if [[ -n "${GITHUB_TOKEN:-}" ]]; then
  auth_header="Authorization: Bearer $GITHUB_TOKEN"
fi

tmp_dirs=()

cleanup_tmp_dirs() {
  local dir
  for dir in "${tmp_dirs[@]}"; do
    if [[ -d "$dir" ]]; then
      rm -rf "$dir"
    fi
  done
}
trap cleanup_tmp_dirs EXIT

get_os() {
  local os
  os=$(uname -s)
  case $os in
  Linux)
    printf "linux"
    ;;
  Darwin)
    printf "macos"
    ;;
  *)
    printf "Unsupported OS: %s\n" "$os" >&2
    exit 1
    ;;
  esac
}

get_arch() {
  local mode=${1:-standard}
  local os=${2:-$(get_os)}
  local arch
  arch=$(uname -m)
  case $arch in
  x86_64)
    if [[ $mode == "standard" ]]; then
      printf "x86_64"
    elif [[ $mode == "archive" && $os == "macos" ]]; then
      printf "x64"
    else
      printf "x64"
    fi
    ;;
  arm64 | aarch64)
    printf "arm64"
    ;;
  *)
    printf "Unsupported architecture: %s\n" "$arch" >&2
    exit 1
    ;;
  esac
}

create_tmp_dir() {
  local prefix=$1
  local os
  os=$(get_os)
  if [[ $os == "macos" ]]; then
    mktemp -d -t "${prefix}"
  else
    mktemp -d -p "/tmp" "${prefix}.XXXXXXXXXX"
  fi
}

version_lt() {
  local v1=$1 v2=$2
  [[ "$v1" == "$v2" ]] && return 1
  local smallest
  smallest=$(printf '%s\n%s\n' "$v1" "$v2" | sort -V | head -n1)
  [[ "$smallest" == "$v1" ]]
}

install_or_update_tool() {
  local tool_name=$1
  local url=$2
  local tmp_dir=$3
  local final_dir=$4
  local archive_type="${5:-.tgz}"
  local archive="$tmp_dir/${tool_name}${archive_type}"

  printf "Removing old %s from %s if it exists...\n" "$tool_name" "$final_dir"
  rm -rf "${final_dir:?}"

  printf "Downloading %s from %s...\n" "$tool_name" "$url"
  curl -L -H "$auth_header" -o "$archive" "$url"

  if [[ $archive_type == ".zip" ]]; then
    unzip -q "$archive" -d "$tmp_dir"
    # Find the extracted directory (could be nested)
    local extracted_dir
    extracted_dir=$(find "$tmp_dir" -mindepth 1 -maxdepth 1 -type d | head -n1)
    if [[ -d "$extracted_dir/bin" ]]; then
      mkdir -p "$final_dir"
      mv "$extracted_dir/bin/"* "$final_dir/"
    elif [[ -d "$extracted_dir" ]]; then
      # Some archives have binaries directly in the root
      mkdir -p "$final_dir"
      find "$extracted_dir" -type f -perm +111 -exec mv {} "$final_dir/" \;
    fi
  else
    tar --strip-components=1 -xzf "$archive" -C "$tmp_dir"
    if [[ ! -d "$tmp_dir/bin" ]]; then
      printf "Error: bin/ folder not found after extracting!\n" >&2
      exit 1
    fi
    mkdir -p "$final_dir"
    mv "$tmp_dir/bin/"* "$final_dir/"
  fi

  chmod +x "$final_dir/"*

  printf "%s installed to %s\n\n" "$tool_name" "$final_dir"
}

install_or_update_mongosh() {
  local final_dir=$1
  local os
  os=$(get_os)
  local arch
  arch=$(get_arch archive "$os")

  local version_tag
  version_tag=$(curl -s -H "$auth_header" \
    https://api.github.com/repos/mongodb-js/mongosh/releases/latest |
    grep -E '"tag_name"' | cut -d '"' -f4)
  local remote_version=${version_tag#v}

  local current_version=
  if command -v mongosh >/dev/null 2>&1; then
    current_version=$(mongosh --version | tr -d '[:space:]')
  fi

  if [[ -z "$current_version" ]] || version_lt "$current_version" "$remote_version"; then
    printf "mongosh: %s -> %s\n" "${current_version:-none}" "$remote_version"
    local tmp_dir
    tmp_dir=$(create_tmp_dir mongosh)
    tmp_dirs+=("$tmp_dir")

    local url platform_name archive_ext
    if [[ $os == "macos" ]]; then
      platform_name="darwin"
      archive_ext=".zip"
    else
      platform_name="linux"
      archive_ext=".tgz"
    fi

    url="https://github.com/mongodb-js/mongosh/releases/download/${version_tag}/mongosh-${remote_version}-${platform_name}-${arch}${archive_ext}"
    install_or_update_tool mongosh "$url" "$tmp_dir" "$final_dir" "$archive_ext"
  else
    printf "mongosh is up to date (%s)\n" "$current_version"
  fi
}

install_or_update_mongodb_tools() {
  local final_dir=$1
  local os
  os=$(get_os)
  local arch
  arch=$(get_arch standard "$os")

  local latest_version
  latest_version=$(curl -s -H "$auth_header" \
    -H "Accept: application/vnd.github.v3+json" \
    https://api.github.com/repos/mongodb/mongo-tools/git/refs/tags |
    sed -nE "s/^.*\"ref\": \"refs\/tags\/[rv]?([0-9]+\.[0-9]+\.[0-9]+)\".*\$/\1/p" |
    sort -V | tail -n1)

  local current_version=
  if command -v bsondump >/dev/null 2>&1; then
    current_version=$(bsondump --version 2>&1 |
      sed -nEn 's/^bsondump version:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*$/\1/p')
  fi

  if [[ -z "$current_version" ]] || version_lt "$current_version" "$latest_version"; then
    printf "mongodb-tools: %s -> %s\n" "${current_version:-none}" "$latest_version"
    local tmp_dir
    tmp_dir=$(create_tmp_dir mongodbtools)
    tmp_dirs+=("$tmp_dir")

    local url platform_name archive_ext
    if [[ $os == "macos" ]]; then
      platform_name="macos"
      archive_ext=".zip"
      url="https://fastdl.mongodb.org/tools/db/mongodb-database-tools-${platform_name}-${arch}-${latest_version}${archive_ext}"
    else
      platform_name="ubuntu2404"
      archive_ext=".tgz"
      url="https://fastdl.mongodb.org/tools/db/mongodb-database-tools-${platform_name}-${arch}-${latest_version}${archive_ext}"
    fi

    install_or_update_tool mongodb-tools "$url" "$tmp_dir" "$final_dir" "$archive_ext"
  else
    printf "mongodb-database-tools are up to date (%s)\n" "$current_version"
  fi
}

install_or_update_atlas_mongo_cli() {
  local final_dir=$1
  local os
  os=$(get_os)
  local arch
  arch=$(get_arch standard "$os")

  local releases_json
  releases_json=$(curl -s -H "$auth_header" \
    https://api.github.com/repos/mongodb/mongodb-atlas-cli/releases)

  local atlas_tag
  atlas_tag=$(printf "%s" "$releases_json" |
    mise x jq -- jq -r '.[] | select(.name|test("MongoDB Atlas CLI")) | .tag_name' |
    head -n1)

  if [[ -n "$atlas_tag" ]]; then
    local atlas_version=${atlas_tag#atlascli/v}
    local current_version=
    if command -v atlas >/dev/null 2>&1; then
      current_version=$(atlas --version 2>&1 |
        sed -nEn 's/^atlascli version:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*$/\1/p')
    fi
    if [[ -z "$current_version" ]] || version_lt "$current_version" "$atlas_version"; then
      printf "atlas-cli: %s -> %s\n" "${current_version:-none}" "$atlas_version"
      local tmp_dir
      tmp_dir=$(create_tmp_dir atlascli)
      tmp_dirs+=("$tmp_dir")
      local encoded=${atlas_tag//\//%2F}

      local url platform_name archive_ext
      if [[ $os == "macos" ]]; then
        platform_name="macos"
        archive_ext=".zip"
        url="https://github.com/mongodb/mongodb-atlas-cli/releases/download/${encoded}/mongodb-atlas-cli_${atlas_version}_${platform_name}_${arch}${archive_ext}"
      else
        platform_name="linux"
        archive_ext=".tar.gz"
        url="https://github.com/mongodb/mongodb-atlas-cli/releases/download/${encoded}/mongodb-atlas-cli_${atlas_version}_${platform_name}_${arch}${archive_ext}"
      fi

      install_or_update_tool atlas-cli "$url" "$tmp_dir" "$final_dir" "$archive_ext"
    else
      printf "atlas-cli is up to date (%s)\n" "$current_version"
    fi
  fi

}

install_or_update_mongosh "$install_path/mongosh"
install_or_update_mongodb_tools "$install_path/mongodb-tools"
install_or_update_atlas_mongo_cli "$install_path/atlas-cli"

if [[ -x "${install_path}/atlas-cli/atlas" ]]; then
  "${install_path}/atlas-cli/atlas" completion zsh >"${XDG_DATA_HOME}/zsh/completions/_atlas"
  printf "atlas completion generated\n"
fi
