#!/usr/bin/env bash

set -e

RELEASE_URL="https://amazon-ecr-credential-helper-releases.s3.us-east-2.amazonaws.com"
test -z "${TMPDIR}" && TMPDIR="$(mktemp -d -t amzecrcredhelp.XXXXXXXXXX)"
BIN_FILE="${TMPDIR}/docker-credential-ecr-login"

last_version() {
  curl -sS "https://api.github.com/repos/awslabs/amazon-ecr-credential-helper/releases/latest" |
    grep '"tag_name":' |
    sed -E 's/.*"([^"]+)".*/\1/' |
    cut -c2-
}

download() {
  test -z "${VERSION}" && local VERSION && VERSION="$(last_version)"
  test -z "${VERSION}" && {
    echo "Unable to get amazon-ecr-credential-helper version." >&2
    exit 1
  }

  rm -f "${BIN_FILE}"

  local OS
  OS=$(uname -s | tr '[:upper:]' '[:lower:]')

  local ARC
  ARC=$([ "$(uname -m)" = "x86_64" ] && echo "amd64" || echo "386")

  local DOWNLOAD_URL="${RELEASE_URL}/${VERSION}/${OS}-${ARC}/docker-credential-ecr-login"

  printf "Download amazon-ecr-credential-helper from %s to '%s'\n" "${DOWNLOAD_URL}" "${TMPDIR}"
  curl -s -L -o "${BIN_FILE}" \
    "${DOWNLOAD_URL}"
}

download
chmod +x "${BIN_FILE}"
"${BIN_FILE}" -v

sudo mv "${BIN_FILE}" /usr/local/bin/docker-credential-ecr-login

printf "Cleanup...\n"
rm -rf "${TMPDIR}"
