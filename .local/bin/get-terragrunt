#!/usr/bin/env bash

set -e

RELEASES_URL="https://github.com/gruntwork-io/terragrunt/releases"
test -z "$TMPDIR" && TMPDIR="$(mktemp -d)"
BIN_FILE="$TMPDIR/terragrunt"

last_version() {
  curl -sL -o /dev/null -w %\{url_effective\} "$RELEASES_URL/latest" |
    rev |
    cut -f1 -d'/' |
    rev
}

download() {
  test -z "$VERSION" && VERSION="$(last_version)"
  test -z "$VERSION" && {
    echo "Unable to get terragrunt version." >&2
    exit 1
  }
  rm -f "$BIN_FILE"

  local OS
  OS=$(uname -s | tr '[:upper:]' '[:lower:]')

  local ARC
  ARC=$([ "$(uname -m)" = "x86_64" ] && echo "amd64" || echo "386")

  local DOWNLOAD_PATH="$RELEASES_URL/download/$VERSION/terragrunt_${OS}_${ARC}"

  printf "Download terragrunt from %s to '%s'\n" "${DOWNLOAD_PATH}" "${TMPDIR}"
  curl -s -L -o "$BIN_FILE" \
    "${DOWNLOAD_PATH}"
}

download
chmod +x "${BIN_FILE}"
"${BIN_FILE}" --version

sudo mv "$BIN_FILE" /usr/local/bin/terragrunt

printf "Cleanup...\n"
rm -rf "${TMPDIR}"
